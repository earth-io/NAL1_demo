<!DOCTYPE html>
<meta charset="utf-8" />
<title>Socket.io</title>
<script type='text/javascript' src='https://code.jquery.com/jquery-1.12.1.js'></script>
<script  type="text/javascript" src="https://cdn.jsdelivr.net/lodash/4.17.2/lodash.js"></script>
<script src="/socket.io/socket.io.js"></script>
<style>
*                     { margin: 0;  padding: 0;  outline: none;  box-sizing: border-box; }
body                  { background: 'white'; margin-top:50; }
button                { font: 20px system-ui; margin:5px;}
#content              { position:relative;  margin-top:2px;  margin-left: 5%; }
.abs                  { position:absolute; }
</style>
<body>
<h1>Communicating with socket.io!</h1>

<p><input type="button" value="Poke the server" id="poke" /></p>
<textarea id="queries" name="queries">HHHHHH</textarea><br />
<input type="hidden" name="formInstance" value="form1" />

<main role="main">
	<ul id="messages"></ul>
	<ul id="messagesChange"></ul>
	<form>
		<input id="you" type="text" placeholder="??" maxlength="2"></input>
		<input id="m" autocomplete="off" type="text"></input>
		<button>Send</button>
	</form>
</main>
<script>
//================================================================================ client lib
var svgNS="http://www.w3.org/2000/svg", DIV='<div>';
var SVGnode= (tag)=> document.createElementNS(svgNS,tag);
var line= (parent,x1,y1,x2,y2,stroke,width,__,aLine)=> {
  aLine=$(SVGnode('line'))
  parent.append(aLine.attr({ x1:x1, y1:y1, x2:x2, y2:y2, stroke:stroke, "stroke-width":width }));
  return aLine;
};
var Tag=(name,s)=> '<'+name+'>'+s+'</'+name+'>';

var append=($p,$c)=>{ $p.append($c); return $c; };
var add=(o,k,v)=> o[k]==undefined ? o[k]=[v]  : o[k].push(v);
var range=(n)=> [...Array(n).keys()];
//================================================================================ VIEW
// var model=Model();  // ***** this is what I had before
var model={
  nCol:5,
  nRow:4,
  col:(k)=> k%model.nCol,    // how do I get this out of the server's model 
  row:(k)=> Math.floor(k/model.nCol),
};
var spacing=30;
var x=   (k)=> (spacing/2)+spacing*model.col(k);  // cell position is based on k
var y=   (k)=> (spacing/2)+spacing*model.row(k);
var cells={};
var addCell=(k,state)=> cells[k]={ state:state, cx:x(k),cy:y(k) };
var links={}; // have branches
var addLink=(id,state,x1,y1,x2,y2)=> links[id]={state:state, branches:{}, x1:x1,y1:y1,x2:x2,y2:y2};

var model_render=(json,__,tiles,renderGraph)=>{
  // VIEW MODEL
	json.cells.map((d)=> addCell(d[0],d[1]) )  // k state
	json.links.map((d,__,args)=>{ 
		args=d[0].split('_'); 
		addLink(d[0],d[1],x(args[0]),y(args[0]),x(args[2]),y(args[2]));
	});

  $('svg').remove();
  $('body').html('');
  var svg=SVGnode('svg');
  $(svg).attr({width:1000, height:1000});
  $('body').append(svg);
  renderGraph=(svg,__,$gl,$gc)=>{
    $gl=append($(svg),$(SVGnode('g')));
    $gc=append($(svg),$(SVGnode('g')));
    $.map(links,(d,id,__,args)=> $gl.append(
			line($gl,d.x1,d.y1,d.x2,d.y2,{placed:'gray',on:'black'}[d.state],{placed:1,on:2}[d.state])
				.attr('class','link_'+id)
		));
    $.map(cells,(d,id)=> $gc.append(
			$(SVGnode('circle'))
				.attr({'class':'cell_'+id, cx:x(id),cy:y(id), r:6, fill:{placed:'gray',on:'green'}[d.state]})
    ));
    return svg;
  };
  
  var tiles=range(model.nRow*model.nCol);
  tiles.map((d,k,__,i=model.col(k),j=model.row(k))=>{ // make a tile for ea cell, put whole graph on ea tile
    renderGraph(append($(svg),$(SVGnode('svg'))
      .attr({'id':'tile_'+k, width:301, height:301, x:i*(spacing+5)*model.nCol, y:j*(spacing+5)*model.nRow})
    ));
    $('#tile_'+k+' .cell_'+k).attr({ r:9});
  });
  tiles.map((d,k,__,i=model.col(k),j=model.row(k))=>{ // put a tree on ea tile
    json.trees[k] && json.trees[k].map((d,__,node)=>{      
        node=$('#tile_'+k+' .link_'+d)[0];
        $(node).attr({ stroke:'yellow','stroke-width':7})
        node.parentElement.appendChild(node);  //  remove and append, so appears on top
    })
  });  
};
//================================================================================ 
var socket = io.connect('http://localhost:8060');
var collectData = []

// The visitor is asked for their username...
//            var username = prompt('What\'s your username?');

// It's sent with the signal "little_newbie" (to differentiate it from "message")
//            socket.emit('little_newbie', username);


// When the button is clicked, a "message" is sent to the server
$('#poke').click(function () {
	var mesFromClient  = $('#queries').val()
	socket.emit('getFullState', 'Hi server, how are you?' + $('#queries').val());
		
//               alert('The server has a message for you: ' + mesFromClient);
})

var msg;
socket.on('replyFullState', function(message) {
//     $('#messages').append(message);
	$('#messages').html(message);
	msg=JSON.parse(message);
	model_render(msg);
	collectData.push( message.len);
	//  alert('The server has a message for you: ' + message);
})

socket.on('replyChangeState', function(message) {
	$('#messagesChange').append(message);
})

socket.on('to_text', function(message) {
		$('#messages').append(message);
		$('#messages').append(message);
		alert('The server has a message for you: ' + message);
})
//            var changesSocket = io('/stateChanges');
</script>
</body>