<!DOCTYPE html>
<meta charset="utf-8" />
<title>Socket.io</title>
<script type='text/javascript' src='https://code.jquery.com/jquery-1.12.1.js'></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/lodash/4.17.2/lodash.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="server/utility.js"></script>
<script type="text/javascript" src="common/layout.js" ></script>
<script type="text/javascript" src="common/render.js" ></script>
<style>
*                     { margin: 0;  padding: 0;  outline: none;  box-sizing: border-box; }
body                  { background: 'white'; margin-top:50; }
button                { font: 20px system-ui; margin:5px;}
#content              { position:relative;  margin-top:2px;  margin-left: 5%; }
.abs                  { position:absolute; }
</style>
<body>
<h1>Communicating using socket.io! 7</h1>
<p><input type="button" value="get full model from server" id="poke" /></p>
<ul id="messages"></ul>
<script>
//================================================================================ client lib
var svgNS="http://www.w3.org/2000/svg", DIV='<div>';
var SVGnode= (tag)=> document.createElementNS(svgNS,tag);
var line= (parent,x1,y1,x2,y2,stroke,width,__,aLine)=> {
  aLine=$(SVGnode('line'))
  parent.append(aLine.attr({ x1:x1, y1:y1, x2:x2, y2:y2, stroke:stroke, "stroke-width":width }));
  return aLine;
};
var Tag=(name,s)=> '<'+name+'>'+s+'</'+name+'>';
//================================================================================ VIEW
const VModel=(json,__,vModel={cells:{},links:{},trees:'-'},addCell,addLink)=>{
	addCell=(k,state)=> vModel.cells[k]={ state:state, cx:x(k),cy:y(k) };
	addLink=(id,state,x1,y1,x2,y2)=> vModel.links[id]={state:state, branches:{}, x1:x1,y1:y1,x2:x2,y2:y2};

  json.cells.map((d)=> addCell(d[0],d[1]) )  // k state
  json.links.map((d,__,args)=>{ 
    args=d[0].split('_'); 
    addLink(d[0],d[1],x(args[0]),y(args[0]),x(args[2]),y(args[2]));
  });
  vModel.trees=json.trees;

  return vModel;
}; 
const modelForcesViewChange=($p,json,__)=> renderTiles($p,json.nRow,json.nCol,VModel(json));
//================================================================================ 
var socket = io.connect('http://localhost:8060');

$(document).ready((__)=>{ 
  socket.emit('reqFullState','I want model.send()'); // or $('#poke').click(()=> ..	)
});
var gs='';  // debug
socket.on('fullState',  (s)=> modelForcesViewChange($('body').html('www'),JSON.parse(s)) );
socket.on('changeState',(s)=> {gs=s;modelForcesViewChange($('body').html('xxx'),JSON.parse(s)); });

//var changesSocket = io('/stateChanges'); // from Gregory
</script>
</body>
