<!DOCTYPE html>
<meta charset='utf-8'>
<script type='text/javascript' src='https://code.jquery.com/jquery-1.12.1.js'></script>
<script  type="text/javascript" src="https://cdn.jsdelivr.net/lodash/4.17.2/lodash.js"></script  >
<script src='server.js'></script>
<style>
*                     { margin: 0;  padding: 0;  outline: none;  box-sizing: border-box; }
body                  { background: 'white'; margin-top:50; }
button                { font: 20px system-ui; margin:5px;}
#content              { position:relative;  margin-top:2px;  margin-left: 5%; }
.abs                  { position:absolute; }
</style>
<div id='controls' style="padding-left: 50px;">
  <button id='pause'   >pause      </button>   <button id='resume' >resume   </button> <br/>
  <button id='faster'  >->         </button>   <button id='slower' >+>       </button> <br/>
 <br/>
</div>
<script>
$('body').css('background','#DDDDDD');
//================================================================================ lib
var svgNS="http://www.w3.org/2000/svg", DIV='<div>';
var SVGnode= (tag)=> document.createElementNS(svgNS,tag);
var line= (parent,x1,y1,x2,y2,stroke,width,__,aLine)=> {
  aLine=$(SVGnode('line'))
  parent.append(aLine.attr({ x1:x1, y1:y1, x2:x2, y2:y2, stroke:stroke, "stroke-width":width }));
  return aLine;
};
var Tag=(name,s)=> '<'+name+'>'+s+'</'+name+'>';
// ========================================================= CONSOLE/CONTROL
/* time lines controls that might be used latter
var controls=()=>{
  $('#resume' ).css({ opacity:0.5 });
  $('#pause'  ).on('click',(ev)=>{ if(!paused){ pause();  $('#pause' ).css({ opacity:0.5 }); $('#resume').css({ opacity:1.0 }); } });
  $('#resume' ).on('click',(ev)=>{ if( paused){ resume(); $('#resume').css({ opacity:0.5 }); $('#pause' ).css({ opacity:1.0 }); } });
  $('#slower' ).on('click',(ev)=>{ DT=DT/2; console.log(DT,'slower'); }); // zzz should be faster
  $('#faster' ).on('click',(ev)=>{ DT=DT*2; console.log(DT,'faster'); }); // zzz should be slower
  $('body'    ).on('click','circle',(ev)=>{ ev.stopPropagation();   
    // array.toString() keeps the ',' but gets rid of the '[' and ']', nuke the ',' w/ .join('')
   // $('#panel').html(div($.map($(ev.target).data('cell').trees,(d)=>div(d.id)).join('')));
  });  
};
*/
var paused =false;
var pause  =()=>{ paused=true;  };
var resume =()=>{ paused=false; };

var DT=500;  // mod DT for faster or slower
// when random(ops)() fails,  0 is returned and 'more' is immediately called again
var attempt=(__,dt)=> paused ?  50 : (random(ops)() ?  DT : 0) ; // dont do anything, but try again in 50ms
// this pattern is like a setInterval,  but you may vary the time delay
// the 'work' is not done by more,  it is done by a fn called within attempt
var more=()=> setTimeout(more,attempt());  // attempt could be inlined, attempt must return a dt

//================================================================================ ROUTER
var linksWhichAreOn={};  // debug

var router={  // tbd: cell & link creation and deletion
  cell_update:(s,__,json=JSON.parse(s))=>{
    $('.cell_'+json.k).attr({ fill: {placed:'gray',on:'green'}[json.state] });
  },
  link_update:(s,__,json=JSON.parse(s))=>{ 
    if(!linksWhichAreOn[json.id]){ linksWhichAreOn[json.id]=0; }
    linksWhichAreOn[json.id]+=1;
    if(linksWhichAreOn[json.id]>1){ return; } // its already on and we dont want to overwrite any yellow
    $('.link_'+json.id).attr({ stroke: {placed:'gray',on:'black'}[json.state] });
  },
  tree_branch:(s,__,json=JSON.parse(s))=>{
    if(linksWhichAreOn[json.linkID]==undefined){ console.log('ERROR','link not on',json.linkID); }
    $('#tile_'+json.treeID+' .link_'+json.linkID).attr({ stroke: 'yellow','stroke-width':7,});
  }
};

var stream=[],sp=0;
var recvr=(s,__,json=JSON.parse(s))=> stream.push(s);  // TBD:  put in array and pull out and play
var pid=setInterval((__,s=stream[sp])=>{
  s!=undefined && $.map(JSON.parse(s),(s,k)=>{ router[k](s); sp+=1; })
},100);
/*
replay stream:
  $('body').html('')
  model_configure(5,4); 
  linksWhichAreOn={};
  model_render(JSON.parse(model_send()));  // sream is 240 in length
  sp=0;

  var pid=setInterval((__,s=stream[sp])=>{
    s!=undefined && $.map(JSON.parse(s),(s,k)=>{ router[k](s); sp+=1; })
  },100);  
*/
//================================================================================ VIEW
var model=Model();  // *****
var spacing=38;
var x=   (k)=> (spacing/2)+spacing*model.col(k);  // cell position
var y=   (k)=> (spacing/2)+spacing*model.row(k); 
var model_render=(json,__,tiles,renderGraph)=>{
  var spacing=30;
  var x=   (k)=> (spacing/2)+spacing*model.col(k);  // cell position is based on k
  var y=   (k)=> (spacing/2)+spacing*model.row(k); 
  $('svg').remove();
  $('body').html('');
  var svg=SVGnode('svg');
  $(svg).attr({width:1000, height:1000});
  $('body').append(svg);
  renderGraph=(svg,__,$gc,$gl)=>{
    $gl=append($(svg),$(SVGnode('g')));
    json.links.map((d,__,args)=>{ 
      args=d[0].split('_'); 
      $gl.append(
        line($gl,x(args[0]),y(args[0]),x(args[2]),y(args[2]),
          {placed:'gray',on:'black'}[d[1]],{placed:1,on:2}[d[1]]).attr('class','link_'+d[0])
      )
    });
    $gc=append($(svg),$(SVGnode('g')));
    json.cells.map((d)=> $gc.append(
      $(SVGnode('circle'))
        .attr({'class':'cell_'+d[0], cx:x(d[0]),cy:y(d[0]), r:6, fill:{placed:'gray',on:'green'}[d[1]]})
    ));
    return svg;
  };
  
  var tiles=range(model.nRow*model.nCol);
  tiles.map((d,k,__,i=model.col(k),j=model.row(k))=>{ // make a tile for ea cell, put whole graph on ea tile
    renderGraph(append($(svg),$(SVGnode('svg'))
      .attr({'id':'tile_'+k, width:301, height:301, x:i*(spacing+5)*model.nCol, y:j*(spacing+5)*model.nRow})
    ));
    $('#tile_'+k+' .cell_'+k).attr({ r:9});
  });
  tiles.map((d,k,__,i=model.col(k),j=model.row(k))=>{ // put a tree on ea tile
    json.trees[k] && json.trees[k].map((d,__,node)=>{      
        node=$('#tile_'+k+' .link_'+d)[0];
        $(node).attr({ stroke:'yellow','stroke-width':7})
        node.parentElement.appendChild(node);  //  remove and append, so appears on top
    })
  });  
};
// ========================================================= 
$(document).ready(function(__,svg,base1,base2){ 
 // controls();
  model.configure(5,4);   // ***** 
  model_render(JSON.parse(model.send()));    // ***** 

  // immediately render the model
  stream.map((s)=>{
    s!=undefined && $.map(JSON.parse(s),(s,k)=>{ router[k](s); }); 
//    sp+=1; // NO!!
  });
  sp=stream.length; // OKAY now add addnl ev.s which will be animated

//console.log(stream.filter((s)=> s.match('3_3_4_7')));
//  console.log(stream.length,'unplaced links',model.links.filter((d)=> d.state!='placed').length);
  
  range(31).map(()=> model.doRandomOp()); // ea op should result in a publish to recvr    // *****  FKD!!
 // model_render(JSON.parse(model_send()));
  return;

  more();  // starts event stream
  var test=(__,s)=> model_render(JSON.parse(model_send())); // get the whole thing and display it
  var tr=()=> trPtr=setInterval(test,500);  // refresh the whole thing
  tr();
  setTimeout(()=>{ console.log(opCnt); clearTimeout(trPtr); },6000); // after 6 sec, 31 ops, freeze the display
});
</script>
<pre>
tbd: add model to view, events, stream of ev, timeline and spaceout 
</pre>